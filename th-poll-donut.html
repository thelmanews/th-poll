<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../th-donut-chart/th-donut-chart.html">
<link rel="import" href="../th-d3-chart/th-d3-chart.html">
<link rel="import" href="th-poll-pair.html">

<!--

@group Thelma Charts
@element th-poll-donut
@blurb Charts the data retreived from th-poll-pair in a donut chart.
@status alpha
@homepage http://github.com/thelmanews/thelma-charts/blob/master/th-poll-donut.html
-->

<polymer-element name="th-poll-donut" extends="th-d3-chart" attributes="pairingKey question">
  <template>
    <core-style ref="theme"></core-style>
    <style>
      :host {
        display: inline-block;
        position: relative;
        width: 200px;
        height: 250px;
      }

      

    </style>
     <th-poll-pair firebaseKey="{{pairingKey}}" data="{{data}}"></th-poll-pair>
     <th-donut-chart chartData="{{chartData}}"></th-donut-chart>
     <svg id="chart"></svg>

  </template>
  <script>
        Polymer('th-poll-donut', {
          // pairingKey: "testing",
          question: "Will Donald Trump be president?",
          _firebaseKey: "",
          _firebaseLocation: "",
          ready: function(){
            var self = this;
            this.questionChanged();
            this.addEventListener('data-change', function(){
              self.dataChanged();
            })
          },
          animate: function(){

          },
          reset: function(){

          },

          // PRIVATE METHODS
          _createUniqueKey: function(str){
            var hash, i, chr, len;

            if (str.length == 0) return str;
            for (i = 0, len = str.length; i < len; i++) {
              chr   = str.charCodeAt(i);
              hash  = ((hash << 5) - hash) + chr;
              hash |= 0; // Convert to 32bit integer
            }

            return hash;
          },


          questionChanged: function(){
            this.pairingKey = this._createUniqueKey(this.question);
          },
          dataChanged: function(){
            console.log("DATA FROM DONUT");
            this.setupChartdata();
          },
          setupChartdata: function(){
            var self = this;
            var total = 0;
            for (var item in this.data){
              total += this.data[item];
            };
            var dataKeys = Object.keys(this.data);
            this.chartData = dataKeys.map(function(key){
              var value = self.data[key];
              return { value: (value/total)*100};
            });
            console.log(this.chartData);

          }
        });

  </script>
</polymer-element>
